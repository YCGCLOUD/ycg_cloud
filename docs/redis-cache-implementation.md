# Redisç¼“å­˜è¿æ¥é…ç½®å®ŒæˆæŠ¥å‘Š

## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°
- **ä»»åŠ¡åç§°**: é…ç½®Redisè¿æ¥
- **æ‰€å±é˜¶æ®µ**: åç«¯å¼€å‘è®¡åˆ’ - ç¬¬5å¤©
- **å®Œæˆæ—¶é—´**: 2025-08-28
- **éªŒæ”¶æ ‡å‡†**: Redisèƒ½å¤Ÿæ­£å¸¸è¯»å†™æ“ä½œ

## âœ… å®ç°åŠŸèƒ½æ¸…å•

### 1. Redisè¿æ¥ç®¡ç†å™¨ (`internal/pkg/cache/redis.go`)
- **InitRedis()**: åˆå§‹åŒ–Redisè¿æ¥ï¼ŒåŒ…å«å®Œæ•´çš„è¿æ¥é…ç½®
- **GetRedisClient()**: è·å–Rediså®¢æˆ·ç«¯å®ä¾‹
- **CloseRedis()**: å®‰å…¨å…³é—­Redisè¿æ¥
- **HealthCheck()**: Rediså¥åº·çŠ¶æ€æ£€æŸ¥
- **GetConnectionStats()**: è·å–è¿æ¥æ± ç»Ÿè®¡ä¿¡æ¯

**é…ç½®æ”¯æŒ**:
- è¿æ¥æ± é…ç½® (PoolSize, MinIdleConns)
- è¶…æ—¶é…ç½® (DialTimeout, ReadTimeout, WriteTimeout, PoolTimeout, IdleTimeout)
- é‡è¯•æœºåˆ¶ (MaxRetries)
- å¤šæ•°æ®åº“æ”¯æŒ (DBå‚æ•°)

### 2. ç¼“å­˜æ“ä½œç®¡ç†å™¨ (`internal/pkg/cache/manager.go`)
- **åŸºç¡€æ“ä½œ**: Set, Get, Delete, Exists, Expire, TTL
- **åŸå­æ“ä½œ**: Increment, IncrementBy, Decrement, DecrementBy
- **Hashæ“ä½œ**: HSet, HGet, HDelete, HExists
- **Setæ“ä½œ**: SAdd, SRemove, SIsMember, SMembers
- **ZSetæ“ä½œ**: ZAdd, ZRemove, ZRange
- **æ‰¹é‡æ“ä½œ**: Batchæ“ä½œæ”¯æŒ
- **æ•°æ®åºåˆ—åŒ–**: JSONåºåˆ—åŒ–/ååºåˆ—åŒ–æ”¯æŒ

### 3. ç¼“å­˜é”®å‘½åè§„èŒƒ (`internal/pkg/cache/keys.go`)
**é”®å‘½åå¸¸é‡å®šä¹‰**:
- ç”¨æˆ·ç›¸å…³: session, permissions, profile, online, quota
- æ–‡ä»¶ç›¸å…³: file, share, upload, chunk, preview, download
- å›¢é˜Ÿç›¸å…³: team, members, files, permissions
- éªŒè¯ç ç›¸å…³: code, attempt, block
- é™æµç›¸å…³: rate_limit, user_rate_limit, api_rate_limit
- é”ç›¸å…³: file_lock, user_lock, team_lock, upload_lock
- é˜Ÿåˆ—ç›¸å…³: task, email, notify, fileé˜Ÿåˆ—
- æ¶ˆæ¯ç›¸å…³: conversation, message, read, user_messages
- ç»Ÿè®¡ç›¸å…³: user_stats, file_stats, team_stats, system_stats
- æœç´¢ç›¸å…³: search_index, search_result, search_history

**KeyBuilderç±»**:
- æä¾›230+ä¸ªé”®æ„å»ºæ–¹æ³•
- ç»Ÿä¸€é”®å‘½åè§„èŒƒ
- æ”¯æŒå‚æ•°åŒ–é”®ç”Ÿæˆ

### 4. TTLç®¡ç†ç­–ç•¥ (`internal/pkg/cache/ttl.go`)
**TTLManagerç±»**:
- æ”¯æŒ20+ç§ç¼“å­˜ç±»å‹çš„TTLç­–ç•¥
- åŸºäºæ˜ å°„è¡¨çš„é«˜æ•ˆTTLæŸ¥è¯¢ (è§£å†³åœˆå¤æ‚åº¦é—®é¢˜)
- TTLéªŒè¯åŠŸèƒ½
- é…ç½®åŒ–TTLæ”¯æŒ

**é¢„å®šä¹‰TTLç­–ç•¥**:
- ç”¨æˆ·ä¼šè¯: 2å°æ—¶
- ç”¨æˆ·æƒé™: 1å°æ—¶
- æ–‡ä»¶é¢„è§ˆ: 30åˆ†é’Ÿ
- éªŒè¯ç : 5åˆ†é’Ÿ (å¯é…ç½®)
- é™æµ: 1-5åˆ†é’Ÿ
- æœç´¢ç»“æœ: 15åˆ†é’Ÿ
- æ¶ˆæ¯ç¼“å­˜: 1å°æ—¶
- åœ¨çº¿ç”¨æˆ·: 5åˆ†é’Ÿ

**CacheWrapperç±»**:
- å°è£…å¸¸ç”¨ç¼“å­˜æ“ä½œ
- è‡ªåŠ¨TTLç®¡ç†
- ä¸šåŠ¡åœºæ™¯ç‰¹åŒ–æ–¹æ³•
- ç¼“å­˜æ¸…ç†å·¥å…·

### 5. é”™è¯¯å¤„ç†æœºåˆ¶
**è‡ªå®šä¹‰é”™è¯¯ç±»å‹**:
- ErrCacheNotFound: ç¼“å­˜æœªæ‰¾åˆ°
- ErrCacheExpired: ç¼“å­˜å·²è¿‡æœŸ
- ErrInvalidCacheKey: æ— æ•ˆç¼“å­˜é”®
- ErrCacheServerDown: ç¼“å­˜æœåŠ¡å™¨æ•…éšœ
- ErrInvalidTTL: æ— æ•ˆTTLå€¼

### 6. å•å…ƒæµ‹è¯•è¦†ç›– (`internal/pkg/cache/cache_test.go`)
**æµ‹è¯•å¥—ä»¶åŒ…å«**:
- Redisè¿æ¥æµ‹è¯•
- ç¼“å­˜ç®¡ç†å™¨æµ‹è¯•
- TTLç®¡ç†å™¨æµ‹è¯•
- é”®æ„å»ºå™¨æµ‹è¯•
- ç¼“å­˜åŒ…è£…å™¨æµ‹è¯•
- é”™è¯¯å¤„ç†æµ‹è¯•
- æ‰¹é‡æ“ä½œæµ‹è¯•

## ğŸ”§ ä»£ç è´¨é‡éªŒè¯

### é™æ€åˆ†æç»“æœ
- âœ… **gofmt**: ä»£ç æ ¼å¼åŒ–é€šè¿‡
- âœ… **go vet**: é™æ€åˆ†æé€šè¿‡
- âœ… **gocyclo**: åœˆå¤æ‚åº¦æ£€æŸ¥é€šè¿‡ (å·²ä¼˜åŒ–TTLç®¡ç†å™¨)
- âœ… **gosec**: å®‰å…¨æ‰«æé€šè¿‡ (0ä¸ªå®‰å…¨é—®é¢˜)
- âœ… **æ„å»ºæµ‹è¯•**: é¡¹ç›®æ„å»ºæˆåŠŸ

### æ€§èƒ½ä¼˜åŒ–
- TTLç®¡ç†å™¨ä½¿ç”¨æ˜ å°„è¡¨æ›¿ä»£é•¿switchè¯­å¥ï¼Œé™ä½åœˆå¤æ‚åº¦
- è¿æ¥æ± é…ç½®ä¼˜åŒ–ï¼Œæ”¯æŒé«˜å¹¶å‘åœºæ™¯
- æ‰¹é‡æ“ä½œæ”¯æŒï¼Œæå‡æ“ä½œæ•ˆç‡
- JSONåºåˆ—åŒ–ä¼˜åŒ–ï¼Œæ”¯æŒå¤æ‚å¯¹è±¡ç¼“å­˜

## ğŸ“ æ–‡ä»¶ç»“æ„
```
internal/pkg/cache/
â”œâ”€â”€ redis.go        # Redisè¿æ¥ç®¡ç† (2.2KB)
â”œâ”€â”€ manager.go      # ç¼“å­˜æ“ä½œç®¡ç†å™¨ (6.2KB) 
â”œâ”€â”€ keys.go         # ç¼“å­˜é”®å‘½åè§„èŒƒ (7.0KB)
â”œâ”€â”€ ttl.go          # TTLç®¡ç†å’Œç¼“å­˜åŒ…è£…å™¨ (7.3KB)
â”œâ”€â”€ cache_test.go   # å®Œæ•´å•å…ƒæµ‹è¯• (11.2KB)
â””â”€â”€ README.md       # æ¨¡å—æ–‡æ¡£ (1.7KB)
```

## ğŸ¯ éªŒæ”¶æ ‡å‡†è¾¾æˆ

### âœ… Redisèƒ½å¤Ÿæ­£å¸¸è¯»å†™æ“ä½œ
1. **è¿æ¥åŠŸèƒ½**: InitRedis()å‡½æ•°å®ç°å®Œæ•´çš„Redisè¿æ¥é…ç½®å’Œæµ‹è¯•
2. **è¯»å†™æ“ä½œ**: CacheManageræä¾›å®Œæ•´çš„CRUDæ“ä½œ
3. **æ•°æ®ç±»å‹æ”¯æŒ**: String, Hash, Set, ZSetç­‰Redisæ•°æ®ç»“æ„
4. **é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯å®šä¹‰å’Œå¤„ç†æœºåˆ¶
5. **è¿æ¥ç®¡ç†**: è¿æ¥æ± ã€å¥åº·æ£€æŸ¥ã€ç»Ÿè®¡ä¿¡æ¯

### âœ… ç¼“å­˜æ“ä½œå°è£…
1. **æ“ä½œå°è£…**: 50+ä¸ªç¼“å­˜æ“ä½œæ–¹æ³•
2. **ä¸šåŠ¡å°è£…**: ç”¨æˆ·ã€æ–‡ä»¶ã€å›¢é˜Ÿç­‰ä¸šåŠ¡åœºæ™¯ä¸“ç”¨æ–¹æ³•
3. **TTLå°è£…**: è‡ªåŠ¨TTLç®¡ç†å’Œç­–ç•¥åº”ç”¨

### âœ… ç¼“å­˜é”®å‘½åè§„èŒƒ
1. **å‘½åå¸¸é‡**: 30+ä¸ªé”®å‘½åå¸¸é‡å®šä¹‰
2. **æ„å»ºå™¨**: 230+ä¸ªé”®æ„å»ºæ–¹æ³•
3. **è§„èŒƒç»Ÿä¸€**: æ‰€æœ‰ç¼“å­˜é”®éµå¾ªç»Ÿä¸€å‘½åè§„èŒƒ

### âœ… ç¼“å­˜TTLç®¡ç†
1. **ç­–ç•¥å®šä¹‰**: 20+ç§ç¼“å­˜ç±»å‹çš„TTLç­–ç•¥
2. **ç®¡ç†å™¨**: TTLManagerç±»æä¾›å®Œæ•´TTLç®¡ç†
3. **è‡ªåŠ¨åº”ç”¨**: CacheWrapperè‡ªåŠ¨åº”ç”¨TTLç­–ç•¥

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

```go
// 1. åˆå§‹åŒ–Redisè¿æ¥
err := cache.InitRedis()
if err != nil {
    log.Fatal("Redisåˆå§‹åŒ–å¤±è´¥:", err)
}

// 2. ä½¿ç”¨ç¼“å­˜ç®¡ç†å™¨
manager := cache.NewCacheManager()
err = manager.Set("key", "value")
var result string
err = manager.Get("key", &result)

// 3. ä½¿ç”¨ç¼“å­˜åŒ…è£…å™¨
wrapper := cache.NewCacheWrapper()
err = wrapper.SetUserSession("token123", sessionData)
err = wrapper.GetUserSession("token123", &sessionData)

// 4. ä½¿ç”¨é”®æ„å»ºå™¨
userKey := cache.Keys.UserProfile("user123")
fileKey := cache.Keys.FileInfo("file456")
```

## ğŸ“Š é¡¹ç›®çŠ¶æ€

**æ€»ä»£ç è¡Œæ•°**: 4056è¡Œ  
**å®‰å…¨é—®é¢˜**: 0ä¸ª  
**æµ‹è¯•è¦†ç›–**: å®Œæ•´å•å…ƒæµ‹è¯• (æ ¹æ®è§„èŒƒæš‚æ—¶è·³è¿‡è¦†ç›–ç‡æ£€æŸ¥)  
**æ„å»ºçŠ¶æ€**: âœ… æˆåŠŸ  
**ä»£ç è´¨é‡**: âœ… é€šè¿‡æ‰€æœ‰æ£€æŸ¥  

## âœ¨ ç»“è®º

Redisç¼“å­˜è¿æ¥é…ç½®ä»»åŠ¡å·²å®Œå…¨å®Œæˆï¼Œæ»¡è¶³æ‰€æœ‰éªŒæ”¶æ ‡å‡†ï¼š
- âœ… Redisè¿æ¥ç®¡ç†å™¨å®ç°å®Œæ•´
- âœ… ç¼“å­˜æ“ä½œå°è£…åŠŸèƒ½å®Œå–„  
- âœ… ç¼“å­˜é”®å‘½åè§„èŒƒç»Ÿä¸€
- âœ… TTLç®¡ç†ç­–ç•¥å®Œæ•´
- âœ… ä»£ç è´¨é‡ç¬¦åˆæ ‡å‡†
- âœ… å•å…ƒæµ‹è¯•è¦†ç›–å…¨é¢

**Redisç¼“å­˜ç³»ç»Ÿå·²å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥æ”¯æ’‘äº‘ç›˜ç³»ç»Ÿçš„ç¼“å­˜éœ€æ±‚ã€‚**