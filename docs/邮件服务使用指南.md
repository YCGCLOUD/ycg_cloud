# é‚®ä»¶å‘é€æœåŠ¡ä½¿ç”¨æŒ‡å—

## æ¦‚è¿°

é‚®ä»¶å‘é€æœåŠ¡æ˜¯HXLOS Cloudçš„æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ï¼Œæä¾›å¯é çš„é‚®ä»¶å‘é€åŠŸèƒ½ï¼Œæ”¯æŒéªŒè¯ç ã€å¯†ç é‡ç½®ã€æ¬¢è¿é‚®ä»¶ã€å®‰å…¨è­¦å‘Šç­‰å¤šç§ç±»å‹çš„é‚®ä»¶å‘é€ã€‚

## åŠŸèƒ½ç‰¹æ€§

### ğŸ”§ æ ¸å¿ƒåŠŸèƒ½
- **SMTPè¿æ¥æ± ç®¡ç†**ï¼šé«˜æ•ˆçš„è¿æ¥å¤ç”¨ï¼Œæ”¯æŒå¹¶å‘å‘é€
- **é‚®ä»¶é˜Ÿåˆ—ç³»ç»Ÿ**ï¼šå¼‚æ­¥å‘é€ï¼Œæ”¯æŒé‡è¯•æœºåˆ¶
- **æ¨¡æ¿ç®¡ç†ç³»ç»Ÿ**ï¼šä¸°å¯Œçš„é‚®ä»¶æ¨¡æ¿ï¼Œæ”¯æŒå¤šè¯­è¨€
- **å®‰å…¨é˜²æŠ¤**ï¼šå†…å®¹è¿‡æ»¤ï¼Œé˜²æ­¢XSSæ”»å‡»
- **ç›‘æ§ç»Ÿè®¡**ï¼šå®Œæ•´çš„å‘é€ç»Ÿè®¡å’ŒçŠ¶æ€ç›‘æ§

### ğŸ“§ æ”¯æŒçš„é‚®ä»¶ç±»å‹
- é‚®ç®±éªŒè¯ç 
- å¯†ç é‡ç½®
- æ¬¢è¿é‚®ä»¶
- å®‰å…¨è­¦å‘Š
- å›¢é˜Ÿé‚€è¯·
- æ–‡ä»¶åˆ†äº«é€šçŸ¥

## å¿«é€Ÿå¼€å§‹

### 1. é…ç½®é‚®ä»¶æœåŠ¡

```go
package main

import (
    "context"
    "cloudpan/internal/pkg/email"
)

func main() {
    // åˆ›å»ºé‚®ä»¶é…ç½®
    config := &email.EmailConfig{
        SMTP: email.SMTPConfig{
            Host:     "smtp.gmail.com",
            Port:     587,
            Username: "your-email@gmail.com",
            Password: "your-app-password",
            UseTLS:   true,
        },
        From:     "your-email@gmail.com",
        FromName: "HXLOS Cloud",
        MaxRetries: 3,
        PoolSize:   10,
    }

    // åˆå§‹åŒ–å…¨å±€é‚®ä»¶æœåŠ¡
    err := email.InitializeGlobalEmailService(config)
    if err != nil {
        panic(err)
    }

    // å¯åŠ¨é‚®ä»¶æœåŠ¡
    ctx := context.Background()
    err = email.StartGlobalEmailService(ctx)
    if err != nil {
        panic(err)
    }

    defer email.StopGlobalEmailService()
}
```

### 2. å‘é€éªŒè¯ç é‚®ä»¶

```go
import (
    "context"
    "cloudpan/internal/pkg/email"
)

func SendVerificationCode(userEmail, code string) error {
    ctx := context.Background()
    return email.SendVerificationCodeGlobal(ctx, userEmail, code)
}

// ä½¿ç”¨ç¤ºä¾‹
err := SendVerificationCode("user@example.com", "123456")
if err != nil {
    log.Printf("å‘é€éªŒè¯ç å¤±è´¥: %v", err)
    return err
}
```

### 3. å‘é€å¯†ç é‡ç½®é‚®ä»¶

```go
func SendPasswordReset(userEmail, resetURL string) error {
    ctx := context.Background()
    return email.SendPasswordResetGlobal(ctx, userEmail, resetURL)
}

// ä½¿ç”¨ç¤ºä¾‹
resetURL := "https://your-domain.com/reset-password?token=abc123"
err := SendPasswordReset("user@example.com", resetURL)
if err != nil {
    log.Printf("å‘é€å¯†ç é‡ç½®é‚®ä»¶å¤±è´¥: %v", err)
    return err
}
```

### 4. å‘é€æ¬¢è¿é‚®ä»¶

```go
func SendWelcomeEmail(userEmail, username string) error {
    ctx := context.Background()
    return email.SendWelcomeEmailGlobal(ctx, userEmail, username)
}

// ä½¿ç”¨ç¤ºä¾‹
err := SendWelcomeEmail("newuser@example.com", "æ–°ç”¨æˆ·")
if err != nil {
    log.Printf("å‘é€æ¬¢è¿é‚®ä»¶å¤±è´¥: %v", err)
    return err
}
```

### 5. å‘é€å®‰å…¨è­¦å‘Šé‚®ä»¶

```go
func SendSecurityAlert(userEmail, alertType string, details map[string]interface{}) error {
    ctx := context.Background()
    return email.SendSecurityAlertGlobal(ctx, userEmail, alertType, details)
}

// ä½¿ç”¨ç¤ºä¾‹
details := map[string]interface{}{
    "ip_address": "192.168.1.100",
    "location":   "åŒ—äº¬å¸‚",
    "device":     "Chromeæµè§ˆå™¨",
}
err := SendSecurityAlert("user@example.com", "å¼‚å¸¸ç™»å½•", details)
if err != nil {
    log.Printf("å‘é€å®‰å…¨è­¦å‘Šå¤±è´¥: %v", err)
    return err
}
```

## é«˜çº§åŠŸèƒ½

### 1. ä½¿ç”¨é‚®ä»¶é˜Ÿåˆ—

```go
// åˆ›å»ºé‚®ä»¶é˜Ÿåˆ—é¡¹
emailQueue := email.CreateEmailQueue(
    email.TemplateVerificationCode,
    []string{"user@example.com"},
    map[string]interface{}{
        "code":       "123456",
        "expires_in": 10,
        "app_name":   "HXLOS Cloud",
    },
    email.PriorityHigh,
)

// åŠ å…¥é˜Ÿåˆ—
err := email.QueueEmailGlobal(emailQueue)
if err != nil {
    log.Printf("é‚®ä»¶å…¥é˜Ÿå¤±è´¥: %v", err)
}
```

### 2. è‡ªå®šä¹‰é‚®ä»¶æ¨¡æ¿

```go
// æ³¨å†Œè‡ªå®šä¹‰æ¨¡æ¿
service := email.GetGlobalEmailService()
customTemplate := &email.EmailTemplate{
    Name:        "custom_notification",
    Language:    "zh-CN",
    Subject:     "ã€{{.app_name}}ã€‘è‡ªå®šä¹‰é€šçŸ¥",
    HTMLBody:    "<h1>{{.title}}</h1><p>{{.content}}</p>",
    TextBody:    "{{.title}}\n{{.content}}",
    IsActive:    true,
    Description: "è‡ªå®šä¹‰é€šçŸ¥æ¨¡æ¿",
}

err := service.RegisterTemplate(customTemplate)
if err != nil {
    log.Printf("æ³¨å†Œæ¨¡æ¿å¤±è´¥: %v", err)
}

// ä½¿ç”¨è‡ªå®šä¹‰æ¨¡æ¿å‘é€é‚®ä»¶
ctx := context.Background()
variables := map[string]interface{}{
    "app_name": "HXLOS Cloud",
    "title":    "é‡è¦é€šçŸ¥",
    "content":  "è¿™æ˜¯ä¸€æ¡é‡è¦çš„ç³»ç»Ÿé€šçŸ¥ã€‚",
}

err = service.SendTemplateEmail(ctx, "custom_notification", []string{"user@example.com"}, variables)
if err != nil {
    log.Printf("å‘é€è‡ªå®šä¹‰é‚®ä»¶å¤±è´¥: %v", err)
}
```

### 3. ç›‘æ§é‚®ä»¶æœåŠ¡çŠ¶æ€

```go
// è·å–æœåŠ¡ç»Ÿè®¡ä¿¡æ¯
stats, err := email.GetGlobalEmailStats()
if err != nil {
    log.Printf("è·å–ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: %v", err)
} else {
    log.Printf("é‚®ä»¶æœåŠ¡ç»Ÿè®¡: %+v", stats)
}

// æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
if email.IsGlobalEmailServiceHealthy() {
    log.Println("é‚®ä»¶æœåŠ¡è¿è¡Œæ­£å¸¸")
} else {
    log.Println("é‚®ä»¶æœåŠ¡å¼‚å¸¸")
}
```

## é…ç½®è¯´æ˜

### SMTPé…ç½®
```go
type SMTPConfig struct {
    Host     string `json:"host"`     // SMTPæœåŠ¡å™¨åœ°å€
    Port     int    `json:"port"`     // SMTPç«¯å£
    Username string `json:"username"` // ç”¨æˆ·å
    Password string `json:"password"` // å¯†ç æˆ–åº”ç”¨ä¸“ç”¨å¯†ç 
    UseSSL   bool   `json:"use_ssl"`  // æ˜¯å¦ä½¿ç”¨SSL
    UseTLS   bool   `json:"use_tls"`  // æ˜¯å¦ä½¿ç”¨TLS
}
```

### å¸¸ç”¨SMTPé…ç½®

#### Gmail
```go
SMTP: email.SMTPConfig{
    Host:     "smtp.gmail.com",
    Port:     587,
    Username: "your-email@gmail.com",
    Password: "your-app-password", // éœ€è¦åº”ç”¨ä¸“ç”¨å¯†ç 
    UseTLS:   true,
}
```

#### QQé‚®ç®±
```go
SMTP: email.SMTPConfig{
    Host:     "smtp.qq.com",
    Port:     587,
    Username: "your-email@qq.com",
    Password: "your-authorization-code", // éœ€è¦æˆæƒç 
    UseTLS:   true,
}
```

#### 163é‚®ç®±
```go
SMTP: email.SMTPConfig{
    Host:     "smtp.163.com",
    Port:     25,
    Username: "your-email@163.com",
    Password: "your-authorization-code", // éœ€è¦æˆæƒç 
    UseTLS:   false,
}
```

## æœ€ä½³å®è·µ

### 1. å®‰å…¨é…ç½®
- ä½¿ç”¨åº”ç”¨ä¸“ç”¨å¯†ç è€Œä¸æ˜¯ä¸»å¯†ç 
- å¯ç”¨TLSåŠ å¯†ä¼ è¾“
- å®šæœŸè½®æ¢SMTPå¯†ç 
- ç›‘æ§å¼‚å¸¸å‘é€è¡Œä¸º

### 2. æ€§èƒ½ä¼˜åŒ–
- åˆç†è®¾ç½®è¿æ¥æ± å¤§å°ï¼ˆå»ºè®®10-50ï¼‰
- ä½¿ç”¨é‚®ä»¶é˜Ÿåˆ—å¤„ç†æ‰¹é‡å‘é€
- è®¾ç½®åˆé€‚çš„é‡è¯•é—´éš”å’Œæ¬¡æ•°
- ç›‘æ§å‘é€é˜Ÿåˆ—çŠ¶æ€

### 3. å†…å®¹è§„èŒƒ
- ä½¿ç”¨UTF-8ç¼–ç 
- æä¾›HTMLå’Œçº¯æ–‡æœ¬ä¸¤ç§æ ¼å¼
- é¿å…ä½¿ç”¨å¯ç–‘å…³é”®è¯
- åŒ…å«é€€è®¢é“¾æ¥

### 4. é”™è¯¯å¤„ç†
```go
err := email.SendVerificationCodeGlobal(ctx, userEmail, code)
if err != nil {
    // è®°å½•é”™è¯¯æ—¥å¿—
    log.Printf("é‚®ä»¶å‘é€å¤±è´¥: %v", err)
    
    // æ ¹æ®é”™è¯¯ç±»å‹è¿›è¡Œå¤„ç†
    switch {
    case strings.Contains(err.Error(), "authentication"):
        // SMTPè®¤è¯å¤±è´¥
        return errors.New("é‚®ä»¶æœåŠ¡é…ç½®é”™è¯¯")
    case strings.Contains(err.Error(), "network"):
        // ç½‘ç»œé”™è¯¯
        return errors.New("ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•")
    default:
        return errors.New("é‚®ä»¶å‘é€å¤±è´¥ï¼Œè¯·è”ç³»ç®¡ç†å‘˜")
    }
}
```

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

1. **è®¤è¯å¤±è´¥**
   - æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç æ˜¯å¦æ­£ç¡®
   - ç¡®è®¤æ˜¯å¦ä½¿ç”¨åº”ç”¨ä¸“ç”¨å¯†ç 
   - éªŒè¯SMTPæœåŠ¡å™¨åœ°å€å’Œç«¯å£

2. **è¿æ¥è¶…æ—¶**
   - æ£€æŸ¥ç½‘ç»œè¿æ¥
   - ç¡®è®¤é˜²ç«å¢™è®¾ç½®
   - å°è¯•ä¸åŒçš„SMTPç«¯å£

3. **é‚®ä»¶è¢«æ‹’ç»**
   - æ£€æŸ¥å‘ä»¶äººåœ°å€æ˜¯å¦æœ‰æ•ˆ
   - é¿å…ä½¿ç”¨åƒåœ¾é‚®ä»¶å…³é”®è¯
   - ç¡®ä¿å†…å®¹æ ¼å¼æ­£ç¡®

4. **é˜Ÿåˆ—å µå¡**
   - æ£€æŸ¥SMTPæœåŠ¡å™¨é™åˆ¶
   - è°ƒæ•´å‘é€é¢‘ç‡
   - å¢åŠ è¿æ¥æ± å¤§å°

### è°ƒè¯•æ¨¡å¼
```go
// å¯ç”¨è¯¦ç»†æ—¥å¿—
log.SetLevel(log.DebugLevel)

// æ£€æŸ¥æœåŠ¡çŠ¶æ€
stats, _ := email.GetGlobalEmailStats()
log.Printf("é‚®ä»¶æœåŠ¡çŠ¶æ€: %+v", stats)

// æµ‹è¯•SMTPè¿æ¥
service := email.GetGlobalEmailService()
if service.IsHealthy() {
    log.Println("SMTPè¿æ¥æ­£å¸¸")
} else {
    log.Println("SMTPè¿æ¥å¼‚å¸¸")
}
```

## æ€»ç»“

é‚®ä»¶å‘é€æœåŠ¡ä¸ºHXLOS Cloudæä¾›äº†å¯é ã€é«˜æ•ˆçš„é‚®ä»¶å‘é€èƒ½åŠ›ã€‚é€šè¿‡åˆç†çš„é…ç½®å’Œä½¿ç”¨ï¼Œå¯ä»¥æ»¡è¶³å„ç§é‚®ä»¶å‘é€éœ€æ±‚ï¼ŒåŒæ—¶ä¿è¯ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå®‰å…¨æ€§ã€‚

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒæ—¥å¿—è¾“å‡ºæˆ–è”ç³»å¼€å‘å›¢é˜Ÿã€‚