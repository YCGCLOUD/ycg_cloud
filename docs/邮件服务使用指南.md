# 邮件发送服务使用指南

## 概述

邮件发送服务是HXLOS Cloud的核心组件之一，提供可靠的邮件发送功能，支持验证码、密码重置、欢迎邮件、安全警告等多种类型的邮件发送。

## 功能特性

### 🔧 核心功能
- **SMTP连接池管理**：高效的连接复用，支持并发发送
- **邮件队列系统**：异步发送，支持重试机制
- **模板管理系统**：丰富的邮件模板，支持多语言
- **安全防护**：内容过滤，防止XSS攻击
- **监控统计**：完整的发送统计和状态监控

### 📧 支持的邮件类型
- 邮箱验证码
- 密码重置
- 欢迎邮件
- 安全警告
- 团队邀请
- 文件分享通知

## 快速开始

### 1. 配置邮件服务

```go
package main

import (
    "context"
    "cloudpan/internal/pkg/email"
)

func main() {
    // 创建邮件配置
    config := &email.EmailConfig{
        SMTP: email.SMTPConfig{
            Host:     "smtp.gmail.com",
            Port:     587,
            Username: "your-email@gmail.com",
            Password: "your-app-password",
            UseTLS:   true,
        },
        From:     "your-email@gmail.com",
        FromName: "HXLOS Cloud",
        MaxRetries: 3,
        PoolSize:   10,
    }

    // 初始化全局邮件服务
    err := email.InitializeGlobalEmailService(config)
    if err != nil {
        panic(err)
    }

    // 启动邮件服务
    ctx := context.Background()
    err = email.StartGlobalEmailService(ctx)
    if err != nil {
        panic(err)
    }

    defer email.StopGlobalEmailService()
}
```

### 2. 发送验证码邮件

```go
import (
    "context"
    "cloudpan/internal/pkg/email"
)

func SendVerificationCode(userEmail, code string) error {
    ctx := context.Background()
    return email.SendVerificationCodeGlobal(ctx, userEmail, code)
}

// 使用示例
err := SendVerificationCode("user@example.com", "123456")
if err != nil {
    log.Printf("发送验证码失败: %v", err)
    return err
}
```

### 3. 发送密码重置邮件

```go
func SendPasswordReset(userEmail, resetURL string) error {
    ctx := context.Background()
    return email.SendPasswordResetGlobal(ctx, userEmail, resetURL)
}

// 使用示例
resetURL := "https://your-domain.com/reset-password?token=abc123"
err := SendPasswordReset("user@example.com", resetURL)
if err != nil {
    log.Printf("发送密码重置邮件失败: %v", err)
    return err
}
```

### 4. 发送欢迎邮件

```go
func SendWelcomeEmail(userEmail, username string) error {
    ctx := context.Background()
    return email.SendWelcomeEmailGlobal(ctx, userEmail, username)
}

// 使用示例
err := SendWelcomeEmail("newuser@example.com", "新用户")
if err != nil {
    log.Printf("发送欢迎邮件失败: %v", err)
    return err
}
```

### 5. 发送安全警告邮件

```go
func SendSecurityAlert(userEmail, alertType string, details map[string]interface{}) error {
    ctx := context.Background()
    return email.SendSecurityAlertGlobal(ctx, userEmail, alertType, details)
}

// 使用示例
details := map[string]interface{}{
    "ip_address": "192.168.1.100",
    "location":   "北京市",
    "device":     "Chrome浏览器",
}
err := SendSecurityAlert("user@example.com", "异常登录", details)
if err != nil {
    log.Printf("发送安全警告失败: %v", err)
    return err
}
```

## 高级功能

### 1. 使用邮件队列

```go
// 创建邮件队列项
emailQueue := email.CreateEmailQueue(
    email.TemplateVerificationCode,
    []string{"user@example.com"},
    map[string]interface{}{
        "code":       "123456",
        "expires_in": 10,
        "app_name":   "HXLOS Cloud",
    },
    email.PriorityHigh,
)

// 加入队列
err := email.QueueEmailGlobal(emailQueue)
if err != nil {
    log.Printf("邮件入队失败: %v", err)
}
```

### 2. 自定义邮件模板

```go
// 注册自定义模板
service := email.GetGlobalEmailService()
customTemplate := &email.EmailTemplate{
    Name:        "custom_notification",
    Language:    "zh-CN",
    Subject:     "【{{.app_name}}】自定义通知",
    HTMLBody:    "<h1>{{.title}}</h1><p>{{.content}}</p>",
    TextBody:    "{{.title}}\n{{.content}}",
    IsActive:    true,
    Description: "自定义通知模板",
}

err := service.RegisterTemplate(customTemplate)
if err != nil {
    log.Printf("注册模板失败: %v", err)
}

// 使用自定义模板发送邮件
ctx := context.Background()
variables := map[string]interface{}{
    "app_name": "HXLOS Cloud",
    "title":    "重要通知",
    "content":  "这是一条重要的系统通知。",
}

err = service.SendTemplateEmail(ctx, "custom_notification", []string{"user@example.com"}, variables)
if err != nil {
    log.Printf("发送自定义邮件失败: %v", err)
}
```

### 3. 监控邮件服务状态

```go
// 获取服务统计信息
stats, err := email.GetGlobalEmailStats()
if err != nil {
    log.Printf("获取统计信息失败: %v", err)
} else {
    log.Printf("邮件服务统计: %+v", stats)
}

// 检查服务健康状态
if email.IsGlobalEmailServiceHealthy() {
    log.Println("邮件服务运行正常")
} else {
    log.Println("邮件服务异常")
}
```

## 配置说明

### SMTP配置
```go
type SMTPConfig struct {
    Host     string `json:"host"`     // SMTP服务器地址
    Port     int    `json:"port"`     // SMTP端口
    Username string `json:"username"` // 用户名
    Password string `json:"password"` // 密码或应用专用密码
    UseSSL   bool   `json:"use_ssl"`  // 是否使用SSL
    UseTLS   bool   `json:"use_tls"`  // 是否使用TLS
}
```

### 常用SMTP配置

#### Gmail
```go
SMTP: email.SMTPConfig{
    Host:     "smtp.gmail.com",
    Port:     587,
    Username: "your-email@gmail.com",
    Password: "your-app-password", // 需要应用专用密码
    UseTLS:   true,
}
```

#### QQ邮箱
```go
SMTP: email.SMTPConfig{
    Host:     "smtp.qq.com",
    Port:     587,
    Username: "your-email@qq.com",
    Password: "your-authorization-code", // 需要授权码
    UseTLS:   true,
}
```

#### 163邮箱
```go
SMTP: email.SMTPConfig{
    Host:     "smtp.163.com",
    Port:     25,
    Username: "your-email@163.com",
    Password: "your-authorization-code", // 需要授权码
    UseTLS:   false,
}
```

## 最佳实践

### 1. 安全配置
- 使用应用专用密码而不是主密码
- 启用TLS加密传输
- 定期轮换SMTP密码
- 监控异常发送行为

### 2. 性能优化
- 合理设置连接池大小（建议10-50）
- 使用邮件队列处理批量发送
- 设置合适的重试间隔和次数
- 监控发送队列状态

### 3. 内容规范
- 使用UTF-8编码
- 提供HTML和纯文本两种格式
- 避免使用可疑关键词
- 包含退订链接

### 4. 错误处理
```go
err := email.SendVerificationCodeGlobal(ctx, userEmail, code)
if err != nil {
    // 记录错误日志
    log.Printf("邮件发送失败: %v", err)
    
    // 根据错误类型进行处理
    switch {
    case strings.Contains(err.Error(), "authentication"):
        // SMTP认证失败
        return errors.New("邮件服务配置错误")
    case strings.Contains(err.Error(), "network"):
        // 网络错误
        return errors.New("网络连接失败，请稍后重试")
    default:
        return errors.New("邮件发送失败，请联系管理员")
    }
}
```

## 故障排查

### 常见问题

1. **认证失败**
   - 检查用户名和密码是否正确
   - 确认是否使用应用专用密码
   - 验证SMTP服务器地址和端口

2. **连接超时**
   - 检查网络连接
   - 确认防火墙设置
   - 尝试不同的SMTP端口

3. **邮件被拒绝**
   - 检查发件人地址是否有效
   - 避免使用垃圾邮件关键词
   - 确保内容格式正确

4. **队列堵塞**
   - 检查SMTP服务器限制
   - 调整发送频率
   - 增加连接池大小

### 调试模式
```go
// 启用详细日志
log.SetLevel(log.DebugLevel)

// 检查服务状态
stats, _ := email.GetGlobalEmailStats()
log.Printf("邮件服务状态: %+v", stats)

// 测试SMTP连接
service := email.GetGlobalEmailService()
if service.IsHealthy() {
    log.Println("SMTP连接正常")
} else {
    log.Println("SMTP连接异常")
}
```

## 总结

邮件发送服务为HXLOS Cloud提供了可靠、高效的邮件发送能力。通过合理的配置和使用，可以满足各种邮件发送需求，同时保证系统的稳定性和安全性。

如有问题，请参考日志输出或联系开发团队。